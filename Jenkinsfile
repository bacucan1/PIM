pipeline {
    agent any
    
    tools {
        maven 'Maven-3.9'
        jdk 'JDK-17'
    }
    
    environment {
        SONAR_TOKEN = credentials('sonarqube-token')
        SONAR_HOST_URL = 'http://localhost:9000'
        API_PROJECT_KEY = 'pim-api'
        API_PROJECT_NAME = 'PIM API'
        TEST_PROJECT_KEY = 'pim-tests'
        TEST_PROJECT_NAME = 'PIM Tests'
    }
    
    options {
        buildDiscarder(logRotator(numToKeepStr: '10', daysToKeepStr: '30'))
        timeout(time: 30, unit: 'MINUTES')
        timestamps()
    }
    
    stages {
        stage('Checkout') {
            steps {
                echo 'üì¶ Descargando c√≥digo fuente...'
                checkout scm
            }
        }
        
        stage('Informaci√≥n del Build') {
            steps {
                script {
                    echo """
                    ‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó
                    ‚ïë         BUILD INFORMATION              ‚ïë
                    ‚ï†‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ï£
                    ‚ïë Job: ${env.JOB_NAME}
                    ‚ïë Build: #${env.BUILD_NUMBER}
                    ‚ïë Branch: ${env.GIT_BRANCH ?: 'N/A'}
                    ‚ïë Java: ${sh(script: 'java -version 2>&1 | head -1', returnStdout: true).trim()}
                    ‚ïë Maven: ${sh(script: 'mvn -version | head -1', returnStdout: true).trim()}
                    ‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù
                    """
                }
            }
        }
        
        stage('Compilar API') {
            steps {
                dir('Api') {
                    echo 'üî® Compilando la API...'
                    sh 'mvn clean compile -DskipTests'
                }
            }
        }
        
        stage('Ejecutar Pruebas Unitarias - API') {
            steps {
                dir('Api') {
                    echo 'üß™ Ejecutando pruebas unitarias de la API...'
                    sh 'mvn test'
                }
            }
            post {
                always {
                    dir('Api') {
                        // Publicar resultados de pruebas JUnit
                        junit testResults: '**/target/surefire-reports/*.xml', 
                             allowEmptyResults: true,
                             healthScaleFactor: 1.0
                        
                        // Publicar reporte de cobertura JaCoCo
                        jacoco(
                            execPattern: '**/target/jacoco.exec',
                            classPattern: '**/target/classes',
                            sourcePattern: '**/src/main/java',
                            exclusionPattern: '**/config/**,**/dto/**,**/entity/**,**/*Application.class'
                        )
                    }
                }
                success {
                    echo '‚úÖ Pruebas unitarias de API completadas exitosamente'
                }
                failure {
                    echo '‚ùå Algunas pruebas de API fallaron'
                }
            }
        }
        
        stage('Ejecutar Pruebas de Integraci√≥n - API') {
            steps {
                dir('Api') {
                    echo 'üîó Ejecutando pruebas de integraci√≥n de la API...'
                    sh 'mvn verify -DskipUnitTests'
                }
            }
            post {
                always {
                    dir('Api') {
                        junit testResults: '**/target/failsafe-reports/*.xml', 
                             allowEmptyResults: true
                    }
                }
            }
        }
        
        stage('Ejecutar Pruebas del Sistema') {
            steps {
                dir('test/PIMTest') {
                    echo 'üß™ Ejecutando pruebas del sistema PIM...'
                    // Compilar y ejecutar las pruebas de PIMTest
                    sh '''
                        # Verificar si existe pom.xml en este directorio
                        if [ -f "pom.xml" ]; then
                            mvn clean test
                        else
                            echo "‚ö†Ô∏è  No se encontr√≥ pom.xml en test/PIMTest"
                            echo "‚ÑπÔ∏è  Las pruebas del sistema se ejecutar√°n desde la ra√≠z del proyecto"
                            cd ../..
                            mvn test -Dtest=PIMTest
                        fi
                    '''
                }
            }
            post {
                always {
                    // Publicar resultados de pruebas del sistema
                    junit testResults: '**/test/**/target/surefire-reports/*.xml', 
                         allowEmptyResults: true
                }
            }
        }
        
        stage('An√°lisis SonarQube - API') {
            steps {
                dir('Api') {
                    echo 'üìä Ejecutando an√°lisis de SonarQube para la API...'
                    withSonarQubeEnv('SonarQube-Server') {
                        sh """
                            mvn sonar:sonar \
                            -Dsonar.projectKey=${API_PROJECT_KEY} \
                            -Dsonar.projectName='${API_PROJECT_NAME}' \
                            -Dsonar.host.url=${SONAR_HOST_URL} \
                            -Dsonar.login=${SONAR_TOKEN} \
                            -Dsonar.java.coveragePlugin=jacoco \
                            -Dsonar.coverage.jacoco.xmlReportPaths=target/site/jacoco/jacoco.xml \
                            -Dsonar.junit.reportPaths=target/surefire-reports,target/failsafe-reports \
                            -Dsonar.sources=src/main/java \
                            -Dsonar.tests=src/test/java \
                            -Dsonar.java.binaries=target/classes \
                            -Dsonar.java.test.binaries=target/test-classes \
                            -Dsonar.exclusions=**/config/**,**/dto/**,**/entity/**,**/*Application.java \
                            -Dsonar.coverage.exclusions=**/config/**,**/dto/**,**/entity/**,**/*Application.java
                        """
                    }
                }
            }
        }
        
        stage('An√°lisis SonarQube - Tests del Sistema') {
            when {
                expression {
                    fileExists('test/PIMTest/pom.xml')
                }
            }
            steps {
                dir('test/PIMTest') {
                    echo 'üìä Ejecutando an√°lisis de SonarQube para las pruebas del sistema...'
                    withSonarQubeEnv('SonarQube-Server') {
                        sh """
                            mvn sonar:sonar \
                            -Dsonar.projectKey=${TEST_PROJECT_KEY} \
                            -Dsonar.projectName='${TEST_PROJECT_NAME}' \
                            -Dsonar.host.url=${SONAR_HOST_URL} \
                            -Dsonar.login=${SONAR_TOKEN}
                        """
                    }
                }
            }
        }
        
        stage('Quality Gate - API') {
            steps {
                echo '‚è≥ Esperando resultado de Quality Gate de la API...'
                timeout(time: 5, unit: 'MINUTES') {
                    script {
                        def qg = waitForQualityGate()
                        if (qg.status != 'OK') {
                            echo "‚ö†Ô∏è  Quality Gate status: ${qg.status}"
                            // No abortar el pipeline, solo advertir
                            unstable(message: "Quality Gate de API fall√≥: ${qg.status}")
                        } else {
                            echo '‚úÖ Quality Gate de API aprobado'
                        }
                    }
                }
            }
        }
        
        stage('Generar Reporte de Cobertura') {
            steps {
                dir('Api') {
                    echo 'üìà Generando reporte consolidado de cobertura...'
                    sh 'mvn jacoco:report'
                }
            }
            post {
                always {
                    // Publicar reporte HTML de JaCoCo
                    publishHTML(target: [
                        allowMissing: false,
                        alwaysLinkToLastBuild: true,
                        keepAll: true,
                        reportDir: 'Api/target/site/jacoco',
                        reportFiles: 'index.html',
                        reportName: 'JaCoCo Coverage Report'
                    ])
                }
            }
        }
        
        stage('Empaquetar API') {
            when {
                expression { 
                    currentBuild.result == null || currentBuild.result == 'SUCCESS' 
                }
            }
            steps {
                dir('Api') {
                    echo 'üì¶ Empaquetando la aplicaci√≥n...'
                    sh 'mvn package -DskipTests'
                }
            }
            post {
                success {
                    dir('Api') {
                        archiveArtifacts artifacts: 'target/*.jar', 
                                       fingerprint: true,
                                       allowEmptyArchive: false
                    }
                }
            }
        }
        
        stage('An√°lisis de Seguridad - OWASP') {
            when {
                expression {
                    return params.RUN_SECURITY_SCAN == true
                }
            }
            steps {
                dir('Api') {
                    echo 'üîí Ejecutando an√°lisis de seguridad OWASP...'
                    sh 'mvn org.owasp:dependency-check-maven:check'
                }
            }
            post {
                always {
                    dir('Api') {
                        publishHTML(target: [
                            allowMissing: true,
                            alwaysLinkToLastBuild: false,
                            keepAll: true,
                            reportDir: 'target',
                            reportFiles: 'dependency-check-report.html',
                            reportName: 'OWASP Dependency Check Report'
                        ])
                    }
                }
            }
        }
    }
    
    post {
        success {
            echo '‚úÖ ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê'
            echo '‚úÖ   Pipeline ejecutado exitosamente'
            echo '‚úÖ ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê'
            script {
                def coverageReport = ""
                try {
                    def jacocoReport = readFile('Api/target/site/jacoco/index.html')
                    coverageReport = "\n\nüìä Revisa el reporte de cobertura en: ${env.BUILD_URL}JaCoCo_Coverage_Report/"
                } catch (Exception e) {
                    coverageReport = ""
                }
                
                emailext(
                    subject: "‚úÖ Build Exitoso: ${env.JOB_NAME} - ${env.BUILD_NUMBER}",
                    body: """
                        <h2>‚úÖ Build completado exitosamente</h2>
                        
                        <table border="1" cellpadding="5">
                            <tr><td><b>Proyecto:</b></td><td>${env.JOB_NAME}</td></tr>
                            <tr><td><b>Build:</b></td><td>#${env.BUILD_NUMBER}</td></tr>
                            <tr><td><b>Duraci√≥n:</b></td><td>${currentBuild.durationString}</td></tr>
                            <tr><td><b>Branch:</b></td><td>${env.GIT_BRANCH ?: 'N/A'}</td></tr>
                        </table>
                        
                        <h3>üìä Enlaces √∫tiles:</h3>
                        <ul>
                            <li><a href="${env.BUILD_URL}">Build Console Output</a></li>
                            <li><a href="${env.BUILD_URL}testReport/">Test Results</a></li>
                            <li><a href="${env.BUILD_URL}JaCoCo_Coverage_Report/">Coverage Report</a></li>
                            <li><a href="${SONAR_HOST_URL}/dashboard?id=${API_PROJECT_KEY}">SonarQube API Dashboard</a></li>
                        </ul>
                        
                        ${coverageReport}
                    """,
                    mimeType: 'text/html',
                    to: 'equipo@empresa.com',
                    attachLog: false
                )
            }
        }
        
        failure {
            echo '‚ùå ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê'
            echo '‚ùå   Pipeline fall√≥'
            echo '‚ùå ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê'
            emailext(
                subject: "‚ùå Build Fallido: ${env.JOB_NAME} - ${env.BUILD_NUMBER}",
                body: """
                    <h2>‚ùå Build fall√≥</h2>
                    
                    <table border="1" cellpadding="5">
                        <tr><td><b>Proyecto:</b></td><td>${env.JOB_NAME}</td></tr>
                        <tr><td><b>Build:</b></td><td>#${env.BUILD_NUMBER}</td></tr>
                        <tr><td><b>Duraci√≥n:</b></td><td>${currentBuild.durationString}</td></tr>
                        <tr><td><b>Branch:</b></td><td>${env.GIT_BRANCH ?: 'N/A'}</td></tr>
                    </table>
                    
                    <h3>üîç Para revisar:</h3>
                    <ul>
                        <li><a href="${env.BUILD_URL}console">Console Output</a></li>
                        <li><a href="${env.BUILD_URL}testReport/">Test Results</a></li>
                    </ul>
                    
                    <p>Por favor revisa los logs para identificar el problema.</p>
                """,
                mimeType: 'text/html',
                to: 'equipo@empresa.com',
                attachLog: true
            )
        }
        
        unstable {
            echo '‚ö†Ô∏è  ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê'
            echo '‚ö†Ô∏è   Build inestable'
            echo '‚ö†Ô∏è  ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê'
            emailext(
                subject: "‚ö†Ô∏è  Build Inestable: ${env.JOB_NAME} - ${env.BUILD_NUMBER}",
                body: """
                    <h2>‚ö†Ô∏è  Build completado con advertencias</h2>
                    
                    <p>El build se complet√≥ pero hay problemas de calidad que requieren atenci√≥n.</p>
                    
                    <table border="1" cellpadding="5">
                        <tr><td><b>Proyecto:</b></td><td>${env.JOB_NAME}</td></tr>
                        <tr><td><b>Build:</b></td><td>#${env.BUILD_NUMBER}</td></tr>
                    </table>
                    
                    <h3>üìä Revisa:</h3>
                    <ul>
                        <li><a href="${SONAR_HOST_URL}/dashboard?id=${API_PROJECT_KEY}">SonarQube Dashboard</a></li>
                        <li><a href="${env.BUILD_URL}testReport/">Test Results</a></li>
                    </ul>
                """,
                mimeType: 'text/html',
                to: 'equipo@empresa.com'
            )
        }
        
        always {
            echo 'üßπ Limpiando workspace...'
            script {
                // Limpiar archivos temporales pero mantener reportes
                try {
                    sh '''
                        find . -type d -name "target" -exec rm -rf {} + 2>/dev/null || true
                        find . -name "*.log" -delete 2>/dev/null || true
                    '''
                } catch (Exception e) {
                    echo "‚ö†Ô∏è  Error al limpiar: ${e.message}"
                }
            }
        }
    }
}

// Par√°metros del pipeline
parameters {
    booleanParam(
        name: 'RUN_SECURITY_SCAN',
        defaultValue: false,
        description: 'Ejecutar an√°lisis de seguridad OWASP'
    )
    booleanParam(
        name: 'DEPLOY_TO_DEV',
        defaultValue: false,
        description: 'Desplegar autom√°ticamente a desarrollo despu√©s del build'
    )
    choice(
        name: 'LOG_LEVEL',
        choices: ['INFO', 'DEBUG', 'WARN'],
        description: 'Nivel de logging para Maven'
    )
}